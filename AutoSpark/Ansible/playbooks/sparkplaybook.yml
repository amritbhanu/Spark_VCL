---
- hosts: sparknodes
  vars:
    master: "{{ MASTER_YES }}"
    spark_url: "{{ SPARK_URL }}"
    user: "{{ USER }}"
    master_ip: "{{ MASTER_IP }}"
  user: "{{user}}"

  tasks:
   - name: Install scala 
     sudo: true
     apt: pkg=scala state=installed update_cache=true

   - name: create spark dir
     sudo: false
     file: path=/home/{{user}}/spark state=directory mode=0755

   - name: download sources
     sudo: false
     get_url: url=http://ftp.wayne.edu/apache//spark/spark-1.6.0/spark-1.6.0-bin-hadoop2.6.tgz dest=/home/{{user}}/spark/

   - name: Unarchive Spark download
     sudo: false
     unarchive: src=/home/{{user}}/spark/spark-1.6.0-bin-hadoop2.6.tgz dest=/home/{{user}}/spark copy=no

   - name: Move spark dir to spark_latest
     sudo: false
     command: mv /home/{{user}}/spark/spark-1.6.0-bin-hadoop2.6 /home/{{user}}/spark/spark_latest

   - name: download hadoop
     sudo: false
     get_url: url=http://mirrors.sonic.net/apache/hadoop/common/hadoop-2.6.0/hadoop-2.6.0.tar.gz dest=/home/{{user}}/

   - name: Unarchive hadoop download
     sudo: false
     unarchive: src=/home/{{user}}/hadoop-2.6.0.tar.gz dest=/home/{{user}}/ copy=no

   - name: Move hadoop-2.6 dir to hadoop
     sudo: false
     command: mv /home/{{user}}/hadoop-2.6.0 /home/{{user}}/hadoop

   - name: Create app/tmp
     sudo: true
     command: mkdir -p /app/hadoop/tmp

   - name: Changing ownership of app/data
     sudo: true
     command: chown -R {{user}} /app/hadoop/tmp

   - name: writing to bashrc
     lineinfile: dest=/home/{{user}}/.bashrc
                regexp=''
                insertafter=EOF
                line='export JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64\nexport HADOOP_INSTALL=/home/aagrawa8/hadoop\nexport PATH=$PATH:$HADOOP_INSTALL/bin\nexport PATH=$PATH:$HADOOP_INSTALL/sbin\nexport HADOOP_MAPRED_HOME=$HADOOP_INSTALL\nexport HADOOP_COMMON_HOME=$HADOOP_INSTALL\nexport HADOOP_HDFS_HOME=$HADOOP_INSTALL\nexport YARN_HOME=$HADOOP_INSTALL\nexport HADOOP_COMMON_LIB_NATIVE_DIR=$HADOOP_INSTALL/lib\nexport HADOOP_OPTS="-Djava.library.path=$HADOOP_INSTALL/lib/native"'

   - name: update bashrc
     sudo: false
     shell: source /home/{{user}}/.bashrc
     args:
        executable: /bin/bash

   - name: writing to hadoop-env.sh
     lineinfile: dest=/home/{{user}}/hadoop/etc/hadoop/hadoop-env.sh
                regexp=''
                insertafter=EOF
                line='export JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64\nexport HADOOP_OPTS=-Djava.net.preferIPv4Stack=true'

   - name: Changing ownership
     sudo: true
     command: chown -R {{user}} /home/{{user}}/hadoop

   - name: Changing permissions of hadoop
     sudo: true
     command: chmod -R 777 /home/{{user}}/hadoop

   - name: Changing permissions of app data
     sudo: true
     command: chmod 750 /app/hadoop/tmp
